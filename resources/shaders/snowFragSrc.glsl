#version 430 core
in vec2 tesUV;in vec3 fragPos,fragNormal;in vec4 shadowSpacePos;in float footDepth;out vec4 fragColor;layout(std430,binding=0)buffer b1{vec3 l[][2];};uniform vec3 lightPos,viewPos;uniform sampler2D shadowMap;float v(){vec3 v=shadowSpacePos.xyz/shadowSpacePos.w*.5+.5;return v.z>=1.?1.:v.z>texture(shadowMap,v.xy).x?0.:1.;}vec3 v(float f){vec3 v=vec3(0);for(int i=0;i<21;i++){vec3 s=l[i][0],c=l[i][1];v+=max(dot(fragNormal,normalize(s-fragPos)),0.)*c*(1./(1.+.09*length(s-fragPos)))*(1.-f);}return v;}void main(){float s=max(dot(normalize(lightPos),vec3(0,1,0)),0.);vec3 f=v(s*.5);fragColor=vec4((vec3(.1)*v()*clamp(1.-fragPos.x/10.,0.,1.)+f+vec3(.3,.5,.7)*pow(1.-max(dot(normalize(viewPos-fragPos),fragNormal),0.),5.)*s*.3)*(1.-footDepth),1);}