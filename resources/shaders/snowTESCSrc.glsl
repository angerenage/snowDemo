#version 430 core
layout(triangles,equal_spacing,ccw)in;in vec2 tcsUV[],tcsTexCoords[];in vec3 tcsPosWorld[];in flat int tcsInstanceIndex[];out vec2 tesUV;out vec3 fragPos,fragNormal;out vec4 shadowSpacePos;out float footDepth;uniform sampler2DArray heightmapArray;uniform sampler2D heightTex;uniform mat4 projection,view,shadowProjection,shadowView;uniform uvec2 chunks;const vec2 v=vec2(-22,100);float t(float v,float t){float s=max(.3-abs(v-t),0.)/.3;return min(v,t)-s*s*s*.3*(1./6.);}void main(){vec2 s=gl_TessCoord.x*tcsUV[0]+gl_TessCoord.y*tcsUV[1]+gl_TessCoord.z*tcsUV[2],x=gl_TessCoord.x*tcsTexCoords[0]+gl_TessCoord.y*tcsTexCoords[1]+gl_TessCoord.z*tcsTexCoords[2];vec3 f=gl_TessCoord.x*tcsPosWorld[0]+gl_TessCoord.y*tcsPosWorld[1]+gl_TessCoord.z*tcsPosWorld[2];uint h=tcsInstanceIndex[0];tesUV=x;vec2 d=vec2(float(h%chunks.x),float(h/chunks.x)),g=vec2(d.x,float(chunks.y-1)-d.y);vec3 u=texture(heightmapArray,vec3(s,h)).xyz*2.;d=(d+s)/vec2(chunks-1);f.y+=.01*smoothstep(.8,1.,d.y);float y=smoothstep(25.,23.,length(f.xz-v)+u.x*2.);f.y-=y*.5;u=mix(u,texture(heightmapArray,vec3(s.x,1.-s.y,uint(g.x+g.y*chunks.x))).xyz*2.,d.y);u.x+=.5;vec3 c=vec3(-u.y,1,-u.z);fragNormal=normalize(c);y=texture(heightTex,x).x;float m=t(y,u.x);footDepth=smoothstep(0.,.3,y-m);footDepth=clamp((u.x-m)*5.,0.,1.);f.y+=m;fragPos=f;vec4 V=vec4(f,1);shadowSpacePos=shadowProjection*shadowView*V;gl_Position=projection*view*V;}