#version 330 core
float b2(vec2 a){a=floor(a);return fract(dot(a,vec2(.5,a.y*.75)));}
#define b4(a)(b2(.5*(a))*.25+b2(a))
#define b16(a)(b4(.5*(a))*.25+b2(a)*.25+b2(a))
#define d0(x)(abs(x)+1e-8)
#define d02(x)(abs(x)+1e-3)
in vec2 fragPos;out vec4 fragColor;uniform mat4 view;uniform float time;uniform vec2 resolution;uniform vec3 sunPosition,moonPosition;uniform sampler2D noiseTex,moonTex;const float a=radians(10.),v=radians(-15.);const vec3 f=vec3(.27,.5,1)*1e-5,b=vec3(5e-7);vec2 t(vec3 v,float a){vec3 f=vec3(0,1,0)*6371e3;float d=dot(f,v);a=d*d+a*a-dot(f,f);if(a<0.)return vec2(-1);a=sqrt(a);return-d+vec2(-a,a);}const float d=acos(-1.),l=1./d,e=d*.5,m=d*2.,r=1./log(2.);vec3 x,n,c;const vec3 s=f+b;vec3 p(vec3 f,float a){return f*a;}vec3 p(float a){return exp2(p(s,-a));}float t(float a){a=1./max(a*2.+.01,.01);return 1e5*a;}float p(float f,float a){float v=a*a;return.25*((1.-v)*pow(1.+v-2.*a*f,-1.5));}float t(float a,float v){return exp2(-v*r*a)*(-1./v)+1./v;}vec3 t(float a,vec3 v){return exp2(-v*r*a)*(-1./v)+1./v;}vec3 p(out vec3 a){float v=dot(c,n),r=dot(c,vec3(0,1,0)),x=dot(vec3(0,1,0),n);x=t(x);r=t(r);vec3 d=p(x);a=p(r);vec3 e=abs(a-d)/d0((p(s,r)-p(s,x))*log(2.));return((p(b,x)*p(v,exp2(-3e-6*x))+p(f,x)*(.375*(1.+v*v)))*e+smoothstep(.9999,.99993,v)*d*3.)*3.;}vec3 p(){float a=dot(c,vec3(0,1,0)),v=1e5/max(1.99,.01);a=t(a);vec3 d=d02(p(a)-p(v))/d02((p(s,a)-p(s,v))*log(2.));return(p(b,v)*.25+p(f,v)*.375)*d*3.;}float t(vec3 a){float v=floor(a.z);const float d=1./64.;float x=17.*d;vec2 f=a.xy*d+v*x;f=vec2(texture(noiseTex,f).x,texture(noiseTex,f+x));return mix(f.x,f.y,a.z-v);}float h(vec3 a){a=vec3(a.x,length(a+vec3(0,6371e3,0))-6371e3,a.z);if(a.y<16e2||a.y>18e2)return 0.;vec3 v=vec3(time,0,time)*.02,f=a*.001+v;float x=a.y-16e2;return smoothstep(.55,.6,t(f)*.5+t(f*2.+v)*.25+t(f*7.-v)*.125+t((f+v)*16.)*.0625)*((1.-exp2(-.01*x))*exp2(-.004*x))*.01;}float g(vec3 a){vec3 v=c*2e2;return exp2(-h(v*.5+a)*2e2);}vec3 g(float a,float v,vec3 f,vec3 s,vec3 x){float r=t(a,1.11);return(s*g(f)*(1.-exp2(-a*log(2.)*2.))*v*e*3.+x*.25*l)*r*d;}vec3 g(vec3 a,float v,vec3 f){float x=t(n,63726e2).y,r=t(n,63728e2).y;vec3 b=n*x,s=n*r,d=(s-b)*(1./float(13));s=d*v+b;x=length(d);vec3 e=vec3(0);r=1.;v=dot(c,n);v=mix(p(v,-.4),p(v,.64),.6);vec3 m=p();for(int a=0;a<13;a++,s+=d){float b=h(s)*x;if(b<=0.)continue;e+=g(b,v,s,f,m)*r;r*=exp2(-b);}return mix(a*r+e,a,clamp(length(b)*1e-5,0.,1.));}vec3 w(vec3 a){float v=length(a);a=mix(a,a*.5,v/(v+1.));return a/sqrt(a*a+1.);}float g(vec2 a){a=fract(a);return fract(sin(dot(a,vec2(12.9898,78.233)))*43758.5453);}vec3 C(vec3 a){float v=g(a.xy/max(abs(a.z),.001)*20.);vec3 f=mix(vec3(1,.95,.8),vec3(.8,.9,1),fract(v*10.))*(v>.992?pow((v-.992)/.008,6.):0.),x=normalize(moonPosition);v=acos(clamp(dot(normalize(a),x),-1.,1.));float b=exp(-pow(v/.2,2.))*.07;f*=1.-clamp(b*3.,0.,1.)*4.;vec3 d=vec3(0);if(v<.07){vec3 v=vec3(0,1,0);if(abs(dot(v,x))>.99)v=vec3(1,0,0);v=normalize(cross(v,x));vec3 f=normalize(a)-x*dot(a,x);vec2 s=vec2(.5)+vec2(dot(f,v),dot(f,normalize(cross(x,v))))/.14;if(length(s-vec2(.5))<.41)d=texture(moonTex,s).xyz,b=0.;}return f+b+d;}void main(){x=normalize(vec3(fragPos,1));x=mat3(view)*x;c=normalize(sunPosition);n=normalize(x);float f=asin(clamp(dot(c,vec3(0,1,0)),-1.,1.));vec3 b=vec3(0),r=vec3(0);if(f>v)r=p(b);vec3 s=C(n);r=mix(r,s,smoothstep(a,v,f));r=g(r,b16(fragPos*resolution),b);r=pow(w(r*.5),vec3(1./2.2));fragColor=vec4(r,1);}